# Issue: Azure AD SSO Fails with AADSTS75011 Error in SailPoint IdentityIQ

## Summary

When integrating SailPoint IdentityIQ (as the SAML Service Provider) with Azure AD (as the Identity Provider), users may encounter the following error during login:

```
AADSTS75011: Authentication method 'X509, MultiFactor, X509Device' by which the user authenticated with the service doesn't match requested authentication method 'Password, ProtectedTransport'.
```

This error occurs when SailPoint's SAML request explicitly includes a `RequestedAuthnContext`, asking Azure AD to use a specific authentication method (`PasswordProtectedTransport`). If the user logs in with a different method (e.g., certificate-based auth or MFA), Azure rejects the request.

---

## Root Cause

The `AuthnRequest` generated by SailPoint includes the following XML block:

```xml
<saml2p:RequestedAuthnContext Comparison="exact">
  <saml2:AuthnContextClassRef xmlns:saml2="urn:oasis:names:tc:SAML:2.0:assertion">
    urn:oasis:names:tc:SAML:2.0:ac:classes:PasswordProtectedTransport
  </saml2:AuthnContextClassRef>
</saml2p:RequestedAuthnContext>
```

This block tells Azure AD to accept **only** username/password authentication. If Azure performs certificate or MFA-based login, it considers the request invalid.

---

## Use Case Scenario: Multiple SPs Sharing the Same IDP (Azure AD)

This issue may occur in environments where **multiple Service Providers (SPs)** are integrated with a **shared Identity Provider (Azure AD)**.

### üîÅ Example Scenario:

* **ForgeRock** and **SailPoint** are both configured as SPs pointing to Azure AD.
* A user first logs in to **ForgeRock** via Azure AD and successfully authenticates using certificate-based login (e.g., X.509).
* In the **same browser session**, the user then tries to access **SailPoint**, which sends a SAML request requiring `PasswordProtectedTransport`.
* Azure AD rejects this second request with error `AADSTS75011` because the initial session used X.509, which doesn't match the requested password-based method.

### üîç Insight:

Azure AD reuses the **existing session and authentication context** unless a new or forced login is required. The mismatch triggers a failure when `RequestedAuthnContext` constraints are applied.

---

## Resolution

### ‚úÖ Recommended Fix: Disable RequestedAuthnContext in SailPoint

To prevent SailPoint from sending a `RequestedAuthnContext`, explicitly disable it in the configuration.

### Steps:

1. **Navigate to SailPoint server** and open the file:

   ```
   identityiq/WEB-INF/config/applicationContext-custom.xml
   ```

2. **Add the following Spring Bean override:**

   ```xml
   <bean id="sailpoint.saml.SAMLService"
         class="sailpoint.saml.SAMLService"
         scope="singleton">
       <property name="includeRequestedAuthnContext" value="false" />
   </bean>
   ```

3. **Restart Tomcat** or the application server hosting IdentityIQ.

4. **Verify** the SAMLRequest using browser tools (e.g., SAML Tracer) to ensure `RequestedAuthnContext` is no longer present.

---

## How to Verify the Issue

### Using Microsoft Edge or Chrome:

1. Open **DevTools** (`F12`) and go to the **Network** tab.
2. Trigger the SSO login from SailPoint.
3. Look for a request to `https://login.microsoftonline.com/...` containing `SAMLRequest`.
4. Copy the `SAMLRequest` value.
5. Use [https://www.samltool.com/decode.php](https://www.samltool.com/decode.php) to decode it, or decode locally using PowerShell.

### PowerShell Decode Script:

```powershell
Add-Type -AssemblyName System.IO.Compression.FileSystem
Add-Type -AssemblyName System.Web

$encoded = "<YourSAMLRequestHere>"
$decodedUrl = [System.Web.HttpUtility]::UrlDecode($encoded)
$bytes = [System.Convert]::FromBase64String($decodedUrl)
$input = New-Object System.IO.MemoryStream(,$bytes)
$output = New-Object System.IO.MemoryStream
$deflate = New-Object System.IO.Compression.DeflateStream($input, [System.IO.Compression.CompressionMode]::Decompress)

$deflate.CopyTo($output)
$deflate.Close()
$output.Position = 0
$reader = New-Object System.IO.StreamReader($output)
$xml = $reader.ReadToEnd()
$reader.Close()
$xml
```

---

## Outcome

Once the `RequestedAuthnContext` is removed, Azure AD will accept any valid user authentication method (password, MFA, X.509, etc.), and the `AADSTS75011` error will no longer occur.

---

## References

* [Microsoft AADSTS75011 Documentation](https://learn.microsoft.com/en-us/azure/active-directory/develop/reference-aadsts-error-codes#aadsts75011)
* [SAMLTool.com Decoder](https://www.samltool.com/decode.php)
* SailPoint IdentityIQ SAML Configuration
